# Storyteller AI

A local-first AI-driven KOTOR/Mass Effect-style interactive story engine set in the Star Wars Expanded Universe. The **V2.20** engine features: event-sourced campaigns, a 12-node LangGraph pipeline (with SceneFrame, NarrativeValidator, and SuggestionRefiner), **Ollama-only** per-role LLM config, LLM-powered KOTOR-style dialogue wheel (4 suggestions via SuggestionRefiner), prose-only Narrator, DialogueTurn contract (SceneFrame + NPCUtterance + PlayerResponses), PartyState companion influence system, BanterManager, era pack companions, 4-lane style RAG, and a SvelteKit CYOA UI.

---

## 1. Project Overview

This repo runs an AI story engine where a player creates a campaign (auto-generated via Architect + Biographer with CYOA character creation, or manual), then plays turn-by-turn by choosing from 4 KOTOR-style dialogue options (PARAGON/INVESTIGATE/RENEGADE/ACTION). Each turn flows through a LangGraph pipeline: Router classifies intent, Mechanic resolves actions deterministically, WorldSim simulates off-screen faction movements, CompanionReaction tracks party dynamics with per-companion influence, ArcPlanner manages Hero's Journey pacing, SceneFrame establishes immutable scene context (topic, subtext, NPC agenda, pressure), Director generates scene instructions, Narrator produces prose-only narration (5-8 sentences, max 250 words), and SuggestionRefiner generates scene-aware suggestions using `qwen3:8b`. The DialogueTurn contract (V2.17) provides a canonical output: SceneFrame + NPCUtterance + PlayerResponses.

Lore and style RAG (LanceDB) with 4-lane layered retrieval (Base Star Wars + Era + Genre + Archetype) grounds the narrative. State is persisted in SQLite (event sourcing); vector storage is LanceDB.

---

## 2. Key Features

- **KOTOR/ME Dialogue Wheel**: 4 suggestions per turn with guaranteed tone diversity (PARAGON blue, INVESTIGATE gold, RENEGADE red, NEUTRAL gray). Generated by SuggestionRefiner (`qwen3:8b`) from the Narrator's prose context (V2.16+, feature-flagged via `ENABLE_SUGGESTION_REFINER`).
- **DialogueTurn Contract (V2.17)**: Canonical turn output: SceneFrame + NPCUtterance + PlayerResponses. Eliminates prose-choice drift.
- **Prose-Only Narrator (V2.15)**: Narrator generates only narrative prose (5-8 sentences). No embedded suggestions. Post-processing strips meta-game artifacts and caps at 250 words.
- **V2 Campaign API**: Event-sourced state; `POST /v2/setup/auto` (Architect + Biographer + CYOA backgrounds), `POST /v2/campaigns`, `GET /v2/campaigns/{id}/state`, `POST /v2/campaigns/{id}/turn`, SSE streaming via `GET /v2/campaigns/{id}/turn_stream`.
- **LangGraph Pipeline**: Router → Mechanic → Encounter → WorldSim → CompanionReaction → ArcPlanner → SceneFrame → Director → Narrator → NarrativeValidator → SuggestionRefiner → Commit.
- **Per-Role LLM Config**: `mistral-nemo:latest` for Director/Narrator (quality-critical), `qwen3:4b` for Architect/Biographer/Casting/KG (lightweight), `qwen3:8b` for Mechanic/Ingestion/SuggestionRefiner. Config in `backend/app/config.py`.
- **PartyState & Companion Influence (V2.20)**: Per-companion influence (-100 to +100) with trust/respect/fear axes. Era pack companions with voice profiles, recruitment triggers, and personal quests. BanterManager with safety guards (no banter during combat/stealth/high-pressure).
- **Gender & Pronoun System (V2.8)**: Male/female selection with pronoun injection into Director + Narrator prompts.
- **4-Lane Style RAG (V2.8)**: Base Star Wars (always-on) + Era + Genre + Archetype style retrieval. 15 genre styles, 4 era styles, hero's journey archetype.
- **Starship Acquisition (V2.10)**: No starting ships; earned in-story via quest/purchase/salvage/faction/theft. REST API for starship management.
- **Companion System**: 108 YAML-based companions with species, voice_tags, motivation, speech_quirk, banter_style. 17 banter styles, inter-party tensions, loyalty arcs (STRANGER → ALLY → TRUSTED → LOYAL). V2.20 era pack companions add voice profiles, recruitment triggers, influence triggers, and banter configuration.
- **Living World**: Time-based world simulation. Every action costs in-game time; WorldSim fires on tick boundaries (default 4 hours) with deterministic faction engine, NPC autonomy, and faction memory.
- **Hero's Journey Arc Planner**: Deterministic 4-stage progression (SETUP → RISING → CLIMAX → RESOLUTION) with 12 Hero's Journey beats, content-aware transitions, and era transition support.
- **Genre Triggers**: Automatic genre detection/shifting based on background and location (11 genres: military_tactical, espionage_thriller, space_western, noir_detective, etc.).
- **Episodic Memory**: Long-term keyword-based turn memory with pivotal event detection and recency-weighted recall.
- **Personality Profiles**: 82 voice tag mappings, 46 trait mappings, 30 archetype mappings for NPC characterization in Director/Narrator prompts.
- **Era Packs (Bible)**: Deterministic factions, locations, NPC casts, backgrounds, and namebanks from `data/static/era_packs/`. Modular YAML structure.
- **Knowledge Graph (optional)**: SQLite KG tables populated via `python -m storyteller extract-knowledge`. Runtime context injection for Director/Narrator.
- **Lore RAG**: Hierarchical parent-child chunking (parent ~1024 / child ~256 tokens) via `ingestion/ingest_lore.py`.

---

## 3. Supported Eras

The engine supports **6 fully-implemented Star Wars eras** with unique factions, locations, NPCs, companions, and quests:

- **Age of Rebellion (0-4 ABY)**: Imperial oppression, Rebel Alliance, asymmetric warfare, found family dynamics. 57 locations, 6 backgrounds, 8+ companions.
- **New Republic (5-19 ABY)**: Post-Empire rebuilding, Thrawn's return, Imperial Remnant conflicts, fragile galactic peace. 75 locations, 8 backgrounds.
- **New Jedi Order (25-29 ABY)**: Yuuzhan Vong invasion, extragalactic threat, desperate survival, Jedi rebuilding under siege. 31 locations, 8 backgrounds.
- **Legacy Era (130-138 ABY)**: Darth Krayt's Sith Empire, three-way war (Sith/Jedi/Fel Empire), shattered galaxy, ancient mysteries resurface. 34 locations, 10 backgrounds, 10 companions.
- **The Dark Times (19-0 BBY)**: Jedi Purge, Order 66 aftermath, rise of the Empire, Inquisitors hunting survivors, seeds of rebellion. 40 locations, 5 backgrounds.
- **Knights of the Old Republic (~3954 BBY)**: Ancient Old Republic, eternal Jedi-Sith conflict, Revan's legacy, Mandalorian clans, Force mysteries, artifact-seeking. 7 locations (WIP), 5 backgrounds.

Each era pack includes:
- **Era-specific factions** with hostility matrices and home locations
- **Locations** with security levels, services, access points, and encounter tables
- **NPC casts**: Canonical NPCs (anchors), recurring NPCs (rotating), and procedural templates
- **Backgrounds** with branching CYOA questions for character creation
- **Companions** with voice profiles, recruitment triggers, influence mechanics, and personal quests
- **Quests, rumors, facts, meters** for dynamic storytelling

Era packs are defined in `data/static/era_packs/{era_id}/` as YAML files. Schema reference: `docs/era_pack_schema_reference.md`.

---

## 4. Architecture

- **Ingestion** → **Retrieval (RAG)** → **Generation (LangGraph + agents)** → **Persistence** → **UI/API**
- **Tech**: Python 3.11+, FastAPI, LangGraph, SQLite (V2 schema via `backend/app/db/migrate.py`), LanceDB (lore_chunks, style_chunks, character_voice_chunks), sentence-transformers embeddings, **Ollama** for LLMs.

---

## 5. Repo Structure

```
backend/                 # FastAPI app and engine
  main.py                 # App entry; mounts V2 router
  llm_client.py           # Ollama client
  app/
    api/                  # v2_campaigns.py (V2), starships.py
    config.py             # Per-role LLM, DB paths, env, token budgets
    constants.py          # Tuning constants (retries, thresholds, banter, arc stages)
    core/
      graph.py            # LangGraph topology + run helpers
      nodes/              # Node implementations (router, mechanic, encounter, world_sim, companion, arc_planner, scene_frame, director, narrator, narrative_validator, suggestion_refiner, commit)
      agents/             # Router, Mechanic, Director, Narrator, Architect, Biographer, Casting, Encounter
      director_validation.py  # Suggestion classification + tone diversity utilities
      quest_tracker.py    # Quest state tracking from era pack YAML
      action_lint.py      # Suggestion validation + padding
      companions.py       # Companion loading + recruitment
      companion_reactions.py  # Affinity, banter, conflicts, inter-party tensions
      party_state.py      # V2.20 PartyState (per-companion influence, trust/respect/fear)
      banter_manager.py   # V2.20 BanterManager (safety guards, cooldowns)
      ledger.py           # Narrative ledger (facts, threads, themes)
      pronouns.py         # Gender/pronoun injection
      personality_profile.py  # NPC personality blocks for prompts
      genre_triggers.py   # Genre detection/shifting
      era_transition.py   # Cross-era progression
      episodic_memory.py  # Long-term turn memory
      state_loader.py     # Build GameState from SQLite
      event_store.py      # Append events, turn number
      transcript_store.py # Rendered turns
    db/                   # connection.py, migrate.py, migrations/ (0001-0018)
    models/               # Pydantic models (state, events, narration, news, starship, director_schemas, dialogue_turn)
    rag/                  # lore_retriever, style_retriever, style_mappings, character_voice_retriever, kg_retriever, retrieval_bundles
    world/                # Era pack loader/models, faction_engine, npc_generator, npc_renderer
    kg/                   # Knowledge graph (extractor, store, entity_resolution, synthesis)
ingestion/                # CLI ingestion
  ingest.py               # TXT/EPUB → LanceDB (flat chunks)
  ingest_lore.py          # PDF/EPUB/TXT → LanceDB (parent-child)
  store.py                # LanceStore (unified schema)
  tagger.py               # Optional LLM metadata enrichment
shared/                   # Shared config/cache/schemas
storyteller/              # Unified CLI (python -m storyteller)
  commands/               # doctor, setup, dev, ingest, query, extract-knowledge
ui/                       # Legacy Streamlit helpers (api_client.py, components.py, themes.py)
frontend/                 # SvelteKit UI (Svelte 5, SvelteKit 2, Vite 6)
streamlit_app.py          # Legacy Streamlit UI
ingestion_app.py          # Streamlit ingestion studio
data/                     # Runtime data (SQLite, LanceDB, lore, style, era packs, companions)
  static/era_packs/       # Bible data (factions, locations, NPCs, backgrounds)
  style/                  # Style docs (base, era, genre)
  companions.yaml         # 108 companions
scripts/                  # Dev helpers (validate_era_pack.py, rebuild_lancedb.py, etc.)
```

---

## 6. Quick Start

### Prerequisites

- **Python 3.11+**
- **Ollama** (for local LLMs): install from https://ollama.com, then pull models:
  ```
  ollama pull mistral-nemo
  ollama pull qwen3:4b
  ollama pull qwen3:8b
  ollama pull nomic-embed-text
  ```

### First-time setup

```bash
python -m venv venv

# Activate venv:
# Windows PowerShell:  .\venv\Scripts\Activate.ps1
# Windows CMD:         .\venv\Scripts\activate.bat
# Linux/macOS:         source venv/bin/activate

pip install -e .              # editable install — no PYTHONPATH needed
python -m storyteller setup   # creates data dirs, copies .env, runs health check
```

### Dev mode (one command)

```bash
python -m storyteller dev
```

Starts **Ollama** (if installed), the **FastAPI backend** (port 8000), and the **SvelteKit UI** (port 5173). Press Ctrl+C to stop all.

### Environment variables

See `.env.example` for the full list. Key variables:

| Variable | Purpose | Default |
|----------|---------|---------|
| `STORYTELLER_DB_PATH` | SQLite path | `./data/storyteller.db` |
| `VECTORDB_PATH` | LanceDB directory | `./data/lancedb` |
| `STORYTELLER_API_URL` | Backend URL for UI | `http://localhost:8000` |
| `STORYTELLER_{ROLE}_MODEL` | Per-role LLM override | see `config.py` |
| `STORYTELLER_DIRECTOR_MODEL` | Director model | `mistral-nemo:latest` |
| `STORYTELLER_NARRATOR_MODEL` | Narrator model | `mistral-nemo:latest` |
| `ERA_PACK_DIR` | Era pack directory | `./data/static/era_packs` |
| `ENABLE_BIBLE_CASTING` | Use Era Pack casting | `1` (on) |
| `ENABLE_PROCEDURAL_NPCS` | Deterministic procedural NPCs | `1` (on) |
| `ENABLE_SUGGESTION_REFINER` | LLM-based suggestion refinement (V2.16) | `1` (on) |
| `DEV_CONTEXT_STATS` | Token budgeting stats in response | `0` (off) |
| `WORLD_TICK_INTERVAL_HOURS` | WorldSim tick interval | `4` |

---

## 7. How to Play

1. Start backend and UI: `python -m storyteller dev`
2. In the browser (http://localhost:5173): create a campaign with era, background, and gender selection.
3. Read the opening scene and choose from the 4 KOTOR-style dialogue options.
4. Each option has a tone (PARAGON/INVESTIGATE/RENEGADE) that affects companion approval, alignment, and faction reputation.

---

## 8. Tests

```powershell
python -m pytest backend/tests/ -q --tb=short
```

587 tests passing across 48 test files. Key test files: test_ledger, test_director_suggestions, test_companion_deep, test_v2_campaigns, test_dialogue_turn, test_companion_era_pack, test_suggestion_refiner, test_narrative_validator.

---

## 9. Troubleshooting

- **ModuleNotFoundError: No module named 'backend'**
  Ensure the package is installed: `pip install -e .` from the project root.

- **Lore/style not found or empty**
  Ensure `VECTORDB_PATH` matches the path used for ingestion. Run `python scripts/verify_lore_store.py --db <path>`.

- **Ollama connection errors**
  Start Ollama (`ollama serve`) and pull the models: `ollama pull mistral-nemo && ollama pull qwen3:4b`.

- **SQLite path / migration**
  Apply migrations: `python -m backend.app.db.migrate --db ./data/storyteller.db`.

- **Embedding dimension mismatch**
  Recreate tables: `python scripts/rebuild_lancedb.py --db ./data/lancedb`.

- **First run slow**
  First ingestion or retrieval may download the sentence-transformers model (~80MB).

---

## 10. License / Credits

Not specified in the repo; omit or add per your project policy.

---

## 10. How the game loop works (strict contract)

Each turn now follows an authoritative backend flow:

1. **Input routing**
   - Backend accepts either legacy `user_input` free text or typed `intent`.
2. **Deterministic mechanics resolver**
   - `d20 + skill_mod + situational_mod` vs tiered DC `{5,10,15,20,25}`.
   - Produces canonical `outcome` and `state_delta`.
   - Narrator is not allowed to override these results.
3. **Narration + validation + repair**
   - Narrator renders prose.
   - Validator checks schema, choice quality, lore constraints, and contradiction against truth ledger facts.
   - Up to 2 repair passes, then safe fallback choices.
4. **Commit + truth ledger + progression**
   - StateDelta facts are appended to SQLite `truth_ledger`.
   - Scene beat budget decrements each turn; scene transitions when beats hit zero.
   - Objective progression updates from StateDelta objective entries.

### TurnContract API object

Every turn response includes a `turn_contract` object with:

- `scene_goal`
- `obstacle`
- `stakes`
- `choices[2..4]` (typed intents + risk + cost)
- `outcome`
- `state_delta`
- `narration`
- `next_scene_hint` (optional)

Legacy fields like `narrated_text` and `suggested_actions` are still returned for backward compatibility.

## 11. API contract

### Turn request (`POST /v2/campaigns/{id}/turn` and `/turn_stream`)

- Legacy:
```json
{ "user_input": "I sneak past the guard" }
```

- Typed intent:
```json
{
  "user_input": "",
  "intent": {
    "intent_type": "SNEAK",
    "target_ids": { "npc_id": "guard_1" },
    "params": { "approach": "silent" }
  }
}
```

### Turn response

Response still includes existing fields and now adds:

```json
{
  "turn_contract": {
    "scene_goal": "...",
    "obstacle": "...",
    "stakes": "...",
    "choices": [
      {
        "id": "choice_1",
        "label": "...",
        "intent": { "intent_type": "INVESTIGATE", "target_ids": {}, "params": {} },
        "risk": "med",
        "cost": { "time_minutes": 5 }
      }
    ],
    "outcome": { "result": "PARTIAL" },
    "state_delta": { "time_minutes": 5 },
    "narration": "..."
  }
}
```

## 12. How to run Svelte UI locally

```bash
cd frontend
npm install
npm run dev
```

Backend:

```bash
python -m backend.main
```

Then open: `http://localhost:5173`

## 13. Gameplay debug checklist

- `turn_contract.choices` length is 2-4 and each has `intent.intent_type`.
- `turn_contract.outcome` matches mechanic debug roll/DC (narrator prose can differ in style, not result).
- Validation warnings are logged when repair attempts run.
- `truth_ledger` table receives facts each turn.
- Scene budget decrements (`world_state_json.scene.beats_remaining`) and triggers transitions at zero.
- Objectives update to `completed` and spawn follow-up objective when objective deltas occur.
